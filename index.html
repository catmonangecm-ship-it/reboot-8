<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCA Trading Bot - MetaMask</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .wallet-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: fadeInUp 0.8s;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 239, 125, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(235, 51, 73, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 14px;
        }

        .status.connected {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .status.disconnected {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: fadeInUp 0.8s;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .info-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .info-box h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .info-box p {
            margin: 5px 0;
            font-size: 0.95em;
        }

        .dca-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .dca-status h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
        }

        .stat-value {
            color: #333;
            font-weight: bold;
        }

        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .history-item.success {
            border-left-color: #38ef7d;
        }

        .history-item.failed {
            border-left-color: #f45c43;
        }

        .history-time {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .history-details {
            font-size: 0.95em;
            color: #333;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .network-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }

        .network-bsc {
            background: #f3ba2f;
            color: #000;
        }

        .swap-switch {
            text-align: center;
            margin: 15px 0;
        }

        .swap-switch button {
            background: #f0f0f0;
            border: none;
            padding: 10px 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .swap-switch button:hover {
            background: #e0e0e0;
            transform: rotate(180deg);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .wallet-info {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ DCA Trading Bot</h1>
            <p>Investissement automatique + Swap Manuel avec MetaMask</p>
        </div>

        <div class="wallet-section">
            <div class="wallet-info">
                <div>
                    <span id="walletStatus" class="status disconnected">Non connect√©</span>
                    <span id="networkBadge" class="network-badge" style="display: none;"></span>
                </div>
                <div>
                    <span id="walletAddress" style="color: #666; font-weight: bold;"></span>
                </div>
                <div>
                    <button id="connectBtn" class="btn btn-primary" onclick="connectWallet()">
                        Connecter MetaMask
                    </button>
                </div>
            </div>
        </div>

        <div id="connectedContent" style="display: none;">
            <div class="alert alert-warning">
                ‚ö†Ô∏è <strong>Important:</strong> Assurez-vous d'avoir du BNB pour les frais de r√©seau (~0.001 BNB par transaction)
            </div>

            <div class="grid">
                <!-- DCA Configuration -->
                <div class="card">
                    <h2>‚öôÔ∏è Configuration DCA</h2>
                    
                    <div class="form-group">
                        <label>R√©seau</label>
                        <select id="networkSelect" onchange="updateNetwork()">
                            <option value="bsc">Binance Smart Chain (BSC)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Crypto √† acheter</label>
                        <select id="cryptoSelect" onchange="updateCryptoInfo()">
                            <option value="">-- S√©lectionner une crypto --</option>
                        </select>
                    </div>

                    <div class="alert alert-info" id="cryptoInfo" style="display: none;">
                        üí° <span id="cryptoDescription"></span>
                    </div>

                    <div class="form-group">
                        <label>Montant par achat (USDT)</label>
                        <input type="number" id="amountInput" step="0.1" min="0.1" placeholder="10" value="10">
                    </div>
                    
                    <div class="form-group">
                        <label>Balance USDT: <span id="usdtBalance">0</span> USDT</label>
                        <label>Balance BNB: <span id="bnbBalance">0</span> BNB</label>
                    </div>

                    <div class="form-group">
                        <label>Intervalle</label>
                        <select id="intervalSelect">
                            <option value="3600">Toutes les heures</option>
                            <option value="21600">Toutes les 6 heures</option>
                            <option value="43200">Toutes les 12 heures</option>
                            <option value="86400">Tous les jours</option>
                            <option value="604800">Toutes les semaines</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Slippage tol√©r√© (%)</label>
                        <input type="number" id="slippageInput" value="2" min="0.5" max="50" step="0.5">
                        <small style="color: #666;">Recommand√©: 2-5% pour √©viter les √©checs</small>
                    </div>

                    <button id="buyNowBtn" class="btn btn-primary" onclick="buyNowManual()" style="width: 100%; margin-top: 10px;">
                        ‚ö° Acheter Maintenant
                    </button>

                    <button id="startDcaBtn" class="btn btn-success" onclick="startDCA()" style="width: 100%; margin-top: 10px;">
                        üöÄ D√©marrer le DCA Auto
                    </button>

                    <button id="stopDcaBtn" class="btn btn-danger" onclick="stopDCA()" style="width: 100%; margin-top: 10px; display: none;">
                        ‚è∏Ô∏è Arr√™ter le DCA
                    </button>
                </div>

                <!-- Swap Manuel -->
                <div class="card">
                    <h2>üîÑ Swap Manuel</h2>
                    <p style="color: #666; margin-bottom: 20px;">√âchangez vos tokens directement via PancakeSwap</p>
                    
                    <div class="form-group">
                        <label>De (Token source)</label>
                        <select id="swapFromToken" onchange="updateSwapBalance()">
                            <option value="">-- S√©lectionner --</option>
                            <option value="0x55d398326f99059fF775485246999027B3197955">USDT</option>
                            <option value="0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c">BNB</option>
                            <option value="0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82">CAKE</option>
                            <option value="0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c">BTC</option>
                            <option value="0x2170Ed0880ac9A755fd29B2688956BD959F933F8">ETH</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Montant √† √©changer</label>
                        <input type="number" id="swapAmount" step="0.0001" min="0" placeholder="0.0">
                        <small style="color: #666;">Balance: <span id="swapFromBalance">0</span></small>
                    </div>

                    <div class="swap-switch">
                        <button onclick="switchSwapTokens()">‚áÖ</button>
                    </div>

                    <div class="form-group">
                        <label>Vers (Token destination)</label>
                        <select id="swapToToken">
                            <option value="">-- S√©lectionner --</option>
                            <option value="0x55d398326f99059fF775485246999027B3197955">USDT</option>
                            <option value="0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c">BNB</option>
                            <option value="0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82">CAKE</option>
                            <option value="0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c">BTC</option>
                            <option value="0x2170Ed0880ac9A755fd29B2688956BD959F933F8">ETH</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Vous recevrez (estimation)</label>
                        <input type="text" id="swapEstimate" readonly placeholder="0.0" style="background: #f8f9fa;">
                    </div>

                    <div class="form-group">
                        <label>Slippage (%)</label>
                        <input type="number" id="swapSlippage" value="2" min="0.5" max="50" step="0.5">
                    </div>

                    <button class="btn btn-success" onclick="getSwapEstimate()" style="width: 100%;">
                        üí∞ Obtenir le prix
                    </button>

                    <button class="btn btn-primary" onclick="executeSwap()" style="width: 100%; margin-top: 10px;">
                        üîÑ √âchanger
                    </button>
                </div>

                <!-- Statut DCA -->
                <div class="card">
                    <h2>üìä Statut DCA</h2>
                    
                    <div class="info-box">
                        <h3>Configuration actuelle</h3>
                        <p><strong>Action:</strong> Achat via PancakeSwap ü•û</p>
                        <p><strong>Montant:</strong> <span id="currentAmount">-</span></p>
                        <p><strong>Intervalle:</strong> <span id="currentInterval">-</span></p>
                        <p><strong>Statut:</strong> <span id="dcaStatus">Inactif</span></p>
                    </div>

                    <div class="dca-status">
                        <h3>Statistiques</h3>
                        <div class="stat-item">
                            <span class="stat-label">Prochaine ex√©cution:</span>
                            <span class="stat-value" id="nextExecution">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Achats effectu√©s:</span>
                            <span class="stat-value" id="totalBuys">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total investi:</span>
                            <span class="stat-value" id="totalInvested">0 USDT</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Tokens re√ßus:</span>
                            <span class="stat-value" id="totalTokens">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historique -->
            <div class="card">
                <h2>üìú Historique (DCA + Swaps)</h2>
                <div id="historyContainer">
                    <div class="alert alert-info">
                        Aucune transaction pour le moment
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let userAccount;
        let currentNetwork = 'bsc';
        let dcaInterval;
        let selectedCrypto = null;
        let swapEstimateAmount = 0;
        let dcaConfig = {
            active: false,
            crypto: null,
            amount: 0,
            interval: 0,
            slippage: 2,
            nextRun: null,
            stats: {
                totalBuys: 0,
                totalInvested: 0,
                totalTokens: 0
            }
        };

        const USDT_ADDRESS = '0x55d398326f99059fF775485246999027B3197955';
        const WBNB_ADDRESS = '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c';
        const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';

        const TOP_CRYPTOS = [
            { symbol: 'BNB', name: 'BNB', address: WBNB_ADDRESS, rank: 1 },
            { symbol: 'CAKE', name: 'PancakeSwap', address: '0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82', rank: 2 },
            { symbol: 'BTC', name: 'Bitcoin', address: '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c', rank: 3 },
            { symbol: 'ETH', name: 'Ethereum', address: '0x2170Ed0880ac9A755fd29B2688956BD959F933F8', rank: 4 }
        ];

        const TOKEN_NAMES = {
            '0x55d398326f99059fF775485246999027B3197955': 'USDT',
            '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c': 'BNB',
            '0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82': 'CAKE',
            '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c': 'BTC',
            '0x2170Ed0880ac9A755fd29B2688956BD959F933F8': 'ETH'
        };

        const history = [];

        // ============= CONNEXION WALLET =============

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('‚ùå MetaMask n\'est pas install√©.\n\nInstallez-le depuis: https://metamask.io');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }
            
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== '0x38') {
                    alert('‚ö†Ô∏è Veuillez passer sur le r√©seau BSC avant de continuer');
                    await switchToBSC();
                    return;
                }
                
                updateNetworkDisplay(chainId);
                
                document.getElementById('walletStatus').className = 'status connected';
                document.getElementById('walletStatus').textContent = 'Connect√©';
                document.getElementById('walletAddress').textContent = userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                document.getElementById('connectBtn').textContent = 'D√©connecter';
                document.getElementById('connectBtn').onclick = disconnectWallet;
                document.getElementById('connectedContent').style.display = 'block';
                
                await updateBalances();
                loadCryptoList();
                
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', () => window.location.reload());
                
            } catch (error) {
                console.error('Erreur:', error);
                if (error.code === 4001) {
                    alert('‚ùå Connexion refus√©e par l\'utilisateur');
                } else {
                    alert('‚ùå Erreur lors de la connexion √† MetaMask: ' + error.message);
                }
            }
        }

        async function switchToBSC() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: '0x38' }],
                });
            } catch (error) {
                if (error.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x38',
                            chainName: 'BNB Smart Chain',
                            nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                            rpcUrls: ['https://bsc-dataseed1.binance.org'],
                            blockExplorerUrls: ['https://bscscan.com']
                        }]
                    });
                }
            }
        }

        function disconnectWallet() {
            userAccount = null;
            document.getElementById('walletStatus').className = 'status disconnected';
            document.getElementById('walletStatus').textContent = 'Non connect√©';
            document.getElementById('connectedContent').style.display = 'none';
            document.getElementById('connectBtn').textContent = 'Connecter MetaMask';
            document.getElementById('connectBtn').onclick = connectWallet;
            if (dcaConfig.active) stopDCA();
        }

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                disconnectWallet();
            } else {
                userAccount = accounts[0];
                updateBalances();
            }
        }

        function updateNetworkDisplay(chainId) {
            const badge = document.getElementById('networkBadge');
            badge.style.display = 'inline-block';
            
            if (chainId === '0x38') {
                badge.className = 'network-badge network-bsc';
                badge.textContent = 'BSC';
            } else {
                badge.textContent = 'Mauvais r√©seau!';
                badge.style.background = '#ff6b6b';
            }
        }

        // ============= BALANCES =============

        async function updateBalances() {
            if (!userAccount) return;
            
            try {
                const usdtData = '0x70a08231' + userAccount.substring(2).padStart(64, '0');
                const usdtBalance = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: USDT_ADDRESS, data: usdtData }, 'latest']
                });
                document.getElementById('usdtBalance').textContent = (parseInt(usdtBalance, 16) / 1e18).toFixed(2);
                
                const bnbBalance = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });
                const bnbAmount = (parseInt(bnbBalance, 16) / 1e18).toFixed(4);
                document.getElementById('bnbBalance').textContent = bnbAmount;
                
                if (parseFloat(bnbAmount) < 0.001) {
                    alert('‚ö†Ô∏è ATTENTION: Vous avez moins de 0.001 BNB. Vous risquez de ne pas pouvoir payer les frais de transaction!');
                }
                
            } catch (error) {
                console.error('Erreur balances:', error);
            }
        }

        // ============= DCA =============

        function loadCryptoList() {
            const select = document.getElementById('cryptoSelect');
            select.innerHTML = '<option value="">-- S√©lectionner --</option>';
            
            TOP_CRYPTOS.forEach(crypto => {
                const option = document.createElement('option');
                option.value = crypto.address;
                option.textContent = `${crypto.symbol} - ${crypto.name}`;
                option.dataset.crypto = JSON.stringify(crypto);
                select.appendChild(option);
            });
        }

        function updateCryptoInfo() {
            const select = document.getElementById('cryptoSelect');
            const option = select.options[select.selectedIndex];
            
            if (option.value) {
                selectedCrypto = JSON.parse(option.dataset.crypto);
                document.getElementById('cryptoInfo').style.display = 'block';
                document.getElementById('cryptoDescription').textContent = 
                    `Vous allez acheter du ${selectedCrypto.symbol} avec vos USDT via PancakeSwap`;
            } else {
                selectedCrypto = null;
                document.getElementById('cryptoInfo').style.display = 'none';
            }
        }

        async function buyNowManual() {
            if (!selectedCrypto) {
                alert('S√©lectionnez une crypto');
                return;
            }
            
            const amount = parseFloat(document.getElementById('amountInput').value);
            if (!amount || amount <= 0) {
                alert('Montant invalide');
                return;
            }
            
            const slippage = parseFloat(document.getElementById('slippageInput').value);
            await executePurchase(amount, slippage, selectedCrypto);
        }

        async function executePurchase(amount, slippage, crypto) {
            try {
                console.log('üöÄ D√©marrage achat:', amount, 'USDT ‚Üí', crypto.symbol);
                
                const bnbBal = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [userAccount, 'latest']
                });
                
                const bnbAmount = parseInt(bnbBal, 16) / 1e18;
                
                if (bnbAmount < 0.002) {
                    alert('‚ùå Pas assez de BNB pour les frais!');
                    return;
                }
                
                const amountWei = BigInt(Math.floor(amount * 1e18));
                
                const usdtBalanceData = '0x70a08231' + userAccount.substring(2).padStart(64, '0');
                const usdtBalanceHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: USDT_ADDRESS, data: usdtBalanceData }, 'latest']
                });
                const usdtBalance = BigInt(usdtBalanceHex);
                
                if (usdtBalance < amountWei) {
                    alert('‚ùå Pas assez de USDT!');
                    return;
                }
                
                // Approbation
                const allowanceData = '0xdd62ed3e' + 
                    userAccount.substring(2).toLowerCase().padStart(64, '0') + 
                    PANCAKE_ROUTER.substring(2).toLowerCase().padStart(64, '0');
                
                const allowance = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: USDT_ADDRESS, data: allowanceData }, 'latest']
                });
                
                if (BigInt(allowance) < amountWei) {
                    if (!confirm('Autoriser PancakeSwap √† utiliser vos USDT?')) {
                        return;
                    }
                    
                    const maxApproval = 'ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';
                    const approveData = '0x095ea7b3' + 
                        PANCAKE_ROUTER.substring(2).toLowerCase().padStart(64, '0') + 
                        maxApproval;
                    
                    const approveTx = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: userAccount,
                            to: USDT_ADDRESS,
                            data: approveData,
                            gas: '0x186A0'
                        }]
                    });
                    
                    alert('‚úÖ Approbation envoy√©e! Attendez 10 secondes...');
                    await new Promise(r => setTimeout(r, 10000));
                }
                
                // Quote
                const path = [USDT_ADDRESS, crypto.address];
                const quoteData = '0xd06ca61f' +
                    amountWei.toString(16).padStart(64, '0') +
                    '0000000000000000000000000000000000000000000000000000000000000040' +
                    '0000000000000000000000000000000000000000000000000000000000000002' +
                    USDT_ADDRESS.substring(2).toLowerCase().padStart(64, '0') +
                    crypto.address.substring(2).toLowerCase().padStart(64, '0');
                
                const quoteResult = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: PANCAKE_ROUTER, data: quoteData }, 'latest']
                });
                
                const resultHex = quoteResult.substring(2);
                const amountOut = BigInt('0x' + resultHex.substring(192, 256));
                
                const safeSlippage = Math.max(slippage, 3);
                const amountOutMin = BigInt(Math.floor(Number(amountOut) * (1 - safeSlippage/100)));
                
                if (!confirm(`Confirmer l'achat?\n\n${amount} USDT ‚Üí ~${(Number(amountOut)/1e18).toFixed(6)} ${crypto.symbol}`)) {
                    return;
                }
                
                // Swap
                const deadline = Math.floor(Date.now()/1000) + 1200;
                const userAddr = userAccount.substring(2).toLowerCase().padStart(64, '0');
                
                let swapData;
                if (crypto.address.toLowerCase() === WBNB_ADDRESS.toLowerCase()) {
                    swapData = '0x18cbafe5' + 
                        amountWei.toString(16).padStart(64, '0') +
                        amountOutMin.toString(16).padStart(64, '0') +
                        '00000000000000000000000000000000000000000000000000000000000000a0' +
                        userAddr +
                        deadline.toString(16).padStart(64, '0') +
                        '0000000000000000000000000000000000000000000000000000000000000002' +
                        USDT_ADDRESS.substring(2).toLowerCase().padStart(64, '0') +
                        WBNB_ADDRESS.substring(2).toLowerCase().padStart(64, '0');
                } else {
                    swapData = '0x38ed1739' +
                        amountWei.toString(16).padStart(64, '0') +
                        amountOutMin.toString(16).padStart(64, '0') +
                        '00000000000000000000000000000000000000000000000000000000000000a0' +
                        userAddr +
                        deadline.toString(16).padStart(64, '0') +
                        '0000000000000000000000000000000000000000000000000000000000000002' +
                        USDT_ADDRESS.substring(2).toLowerCase().padStart(64, '0') +
                        crypto.address.substring(2).toLowerCase().padStart(64, '0');
                }
                
                const swapTx = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: PANCAKE_ROUTER,
                        data: swapData,
                        gas: '0x7A120',
                        value: '0x0'
                    }]
                });
                
                dcaConfig.stats.totalBuys++;
                dcaConfig.stats.totalInvested += amount;
                dcaConfig.stats.totalTokens += Number(amountOut) / 1e18;
                
                updateDCAStatus();
                await updateBalances();
                
                addToHistory({
                    type: 'success',
                    crypto: crypto.symbol,
                    amount: amount,
                    txHash: swapTx,
                    date: new Date()
                });
                
                alert(`‚úÖ Achat r√©ussi!\nTX: ${swapTx}`);
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                
                let errorMsg = error.message || 'Erreur inconnue';
                if (errorMsg.includes('user rejected')) errorMsg = 'Transaction annul√©e';
                if (errorMsg.includes('insufficient funds')) errorMsg = 'Fonds insuffisants';
                
                addToHistory({
                    type: 'failed',
                    crypto: crypto?.symbol || 'Unknown',
                    amount: amount,
                    error: errorMsg,
                    date: new Date()
                });
                
                alert('‚ùå ' + errorMsg);
            }
        }

        async function startDCA() {
            if (!selectedCrypto) {
                alert('S√©lectionnez une crypto');
                return;
            }
            
            const amount = parseFloat(document.getElementById('amountInput').value);
            const interval = parseInt(document.getElementById('intervalSelect').value);
            const slippage = parseFloat(document.getElementById('slippageInput').value);
            
            if (!amount || amount <= 0) {
                alert('Montant invalide');
                return;
            }
            
            dcaConfig = {
                active: true,
                crypto: selectedCrypto,
                amount: amount,
                interval: interval,
                slippage: slippage,
                nextRun: Date.now() + interval * 1000,
                stats: dcaConfig.stats
            };
            
            updateDCAStatus();
            
            document.getElementById('startDcaBtn').style.display = 'none';
            document.getElementById('stopDcaBtn').style.display = 'block';
            
            dcaInterval = setInterval(checkAndExecuteDCA, 5000);
            
            alert(`üöÄ DCA d√©marr√© pour ${selectedCrypto.symbol}!`);
        }

        function stopDCA() {
            dcaConfig.active = false;
            clearInterval(dcaInterval);
            
            document.getElementById('startDcaBtn').style.display = 'block';
            document.getElementById('stopDcaBtn').style.display = 'none';
            document.getElementById('dcaStatus').textContent = 'Inactif';
            document.getElementById('nextExecution').textContent = '-';
            
            alert('‚è∏Ô∏è DCA arr√™t√©');
        }

        function updateDCAStatus() {
            document.getElementById('currentAmount').textContent = dcaConfig.amount ? 
                `${dcaConfig.amount} USDT ‚Üí ${dcaConfig.crypto?.symbol || '-'}` : '-';
            
            const intervalText = {
                '3600': 'Toutes les heures',
                '21600': 'Toutes les 6 heures',
                '43200': 'Toutes les 12 heures',
                '86400': 'Tous les jours',
                '604800': 'Toutes les semaines'
            };
            
            document.getElementById('currentInterval').textContent = intervalText[dcaConfig.interval] || '-';
            document.getElementById('dcaStatus').textContent = dcaConfig.active ? 'üü¢ Actif' : 'üî¥ Inactif';
            document.getElementById('totalBuys').textContent = dcaConfig.stats.totalBuys;
            document.getElementById('totalInvested').textContent = `${dcaConfig.stats.totalInvested.toFixed(2)} USDT`;
            document.getElementById('totalTokens').textContent = `${dcaConfig.stats.totalTokens.toFixed(6)} ${dcaConfig.crypto?.symbol || ''}`;
        }

        function checkAndExecuteDCA() {
            if (!dcaConfig.active) return;
            
            const now = Date.now();
            const timeUntilNext = dcaConfig.nextRun - now;
            
            if (timeUntilNext <= 0) {
                executePurchase(dcaConfig.amount, dcaConfig.slippage, dcaConfig.crypto);
                dcaConfig.nextRun = now + dcaConfig.interval * 1000;
            }
            
            const seconds = Math.floor(timeUntilNext / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            let timeText;
            if (days > 0) {
                timeText = `${days}j ${hours % 24}h`;
            } else if (hours > 0) {
                timeText = `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                timeText = `${minutes}m ${seconds % 60}s`;
            } else {
                timeText = `${seconds}s`;
            }
            
            document.getElementById('nextExecution').textContent = timeText;
        }

        // ============= SWAP MANUEL =============

        async function updateSwapBalance() {
            const fromToken = document.getElementById('swapFromToken').value;
            if (!fromToken || !userAccount) return;
            
            try {
                const isFromBNB = fromToken.toLowerCase() === WBNB_ADDRESS.toLowerCase();
                let balance;
                
                if (isFromBNB) {
                    const bnbBal = await window.ethereum.request({
                        method: 'eth_getBalance',
                        params: [userAccount, 'latest']
                    });
                    balance = (parseInt(bnbBal, 16) / 1e18).toFixed(4);
                } else {
                    const balanceData = '0x70a08231' + userAccount.substring(2).padStart(64, '0');
                    const balanceHex = await window.ethereum.request({
                        method: 'eth_call',
                        params: [{ to: fromToken, data: balanceData }, 'latest']
                    });
                    balance = (parseInt(balanceHex, 16) / 1e18).toFixed(4);
                }
                
                document.getElementById('swapFromBalance').textContent = balance;
            } catch (error) {
                console.error('Erreur balance swap:', error);
                document.getElementById('swapFromBalance').textContent = '0';
            }
        }

        function switchSwapTokens() {
            const fromSelect = document.getElementById('swapFromToken');
            const toSelect = document.getElementById('swapToToken');
            
            const tempValue = fromSelect.value;
            fromSelect.value = toSelect.value;
            toSelect.value = tempValue;
            
            document.getElementById('swapEstimate').value = '';
            swapEstimateAmount = 0;
            updateSwapBalance();
        }

        async function getSwapEstimate() {
            const fromToken = document.getElementById('swapFromToken').value;
            const toToken = document.getElementById('swapToToken').value;
            const amount = parseFloat(document.getElementById('swapAmount').value);

            if (!fromToken || !toToken) {
                alert('S√©lectionnez les deux tokens');
                return;
            }

            if (fromToken === toToken) {
                alert('Les tokens doivent √™tre diff√©rents');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Montant invalide');
                return;
            }

            try {
                const amountWei = BigInt(Math.floor(amount * 1e18));
                
                const isFromBNB = fromToken.toLowerCase() === WBNB_ADDRESS.toLowerCase();
                const isToBNB = toToken.toLowerCase() === WBNB_ADDRESS.toLowerCase();
                
                let path;
                if (isFromBNB || isToBNB) {
                    path = [fromToken, toToken];
                } else {
                    path = [fromToken, WBNB_ADDRESS, toToken];
                }

                let pathEncoded = path.map(addr => addr.substring(2).toLowerCase().padStart(64, '0')).join('');
                
                const quoteData = '0xd06ca61f' +
                    amountWei.toString(16).padStart(64, '0') +
                    '0000000000000000000000000000000000000000000000000000000000000040' +
                    path.length.toString(16).padStart(64, '0') +
                    pathEncoded;

                const quoteResult = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: PANCAKE_ROUTER, data: quoteData }, 'latest']
                });

                const resultHex = quoteResult.substring(2);
                const offset = parseInt(resultHex.substring(0, 64), 16) * 2;
                const arrayLength = parseInt(resultHex.substring(offset, offset + 64), 16);
                const lastIndex = offset + 64 + (arrayLength - 1) * 64;
                const amountOut = BigInt('0x' + resultHex.substring(lastIndex, lastIndex + 64));

                swapEstimateAmount = amountOut;
                const estimateDisplay = (Number(amountOut) / 1e18).toFixed(6);
                document.getElementById('swapEstimate').value = estimateDisplay + ' ' + TOKEN_NAMES[toToken];

                const rate = (Number(amountOut) / 1e18) / amount;
                alert(`üí∞ Prix estim√©:\n\n${amount} ${TOKEN_NAMES[fromToken]} = ${estimateDisplay} ${TOKEN_NAMES[toToken]}\n\nTaux: 1 ${TOKEN_NAMES[fromToken]} = ${rate.toFixed(6)} ${TOKEN_NAMES[toToken]}`);

            } catch (error) {
                console.error('Erreur estimation:', error);
                alert('‚ùå Erreur: Impossible d\'obtenir le prix');
            }
        }

        async function executeSwap() {
            const fromToken = document.getElementById('swapFromToken').value;
            const toToken = document.getElementById('swapToToken').value;
            const amount = parseFloat(document.getElementById('swapAmount').value);
            const slippage = parseFloat(document.getElementById('swapSlippage').value);

            if (!fromToken || !toToken) {
                alert('S√©lectionnez les deux tokens');
                return;
            }

            if (fromToken === toToken) {
                alert('Les tokens doivent √™tre diff√©rents');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Montant invalide');
                return;
            }

            if (swapEstimateAmount === 0) {
                alert('Obtenez d\'abord une estimation du prix');
                return;
            }

            try {
                const amountWei = BigInt(Math.floor(amount * 1e18));
                const isFromBNB = fromToken.toLowerCase() === WBNB_ADDRESS.toLowerCase();
                const isToBNB = toToken.toLowerCase() === WBNB_ADDRESS.toLowerCase();

                // V√©rifier balance
                let balance;
                if (isFromBNB) {
                    const bnbBal = await window.ethereum.request({
                        method: 'eth_getBalance',
                        params: [userAccount, 'latest']
                    });
                    balance = BigInt(bnbBal);
                    
                    const minKeep = BigInt(Math.floor(0.002 * 1e18));
                    if (balance < amountWei + minKeep) {
                        alert('‚ùå Balance BNB insuffisante!');
                        return;
                    }
                } else {
                    const balanceData = '0x70a08231' + userAccount.substring(2).padStart(64, '0');
                    const balanceHex = await window.ethereum.request({
                        method: 'eth_call',
                        params: [{ to: fromToken, data: balanceData }, 'latest']
                    });
                    balance = BigInt(balanceHex);
                    
                    if (balance < amountWei) {
                        alert('‚ùå Balance insuffisante!');
                        return;
                    }
                }

                // Approbation si n√©cessaire
                if (!isFromBNB) {
                    const allowanceData = '0xdd62ed3e' + 
                        userAccount.substring(2).toLowerCase().padStart(64, '0') + 
                        PANCAKE_ROUTER.substring(2).toLowerCase().padStart(64, '0');
                    
                    const allowance = await window.ethereum.request({
                        method: 'eth_call',
                        params: [{ to: fromToken, data: allowanceData }, 'latest']
                    });
                    
                    if (BigInt(allowance) < amountWei) {
                        if (!confirm('Autoriser PancakeSwap?')) {
                            return;
                        }
                        
                        const maxApproval = 'ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';
                        const approveData = '0x095ea7b3' + 
                            PANCAKE_ROUTER.substring(2).toLowerCase().padStart(64, '0') + 
                            maxApproval;
                        
                        await window.ethereum.request({
                            method: 'eth_sendTransaction',
                            params: [{
                                from: userAccount,
                                to: fromToken,
                                data: approveData,
                                gas: '0x186A0'
                            }]
                        });
                        
                        alert('‚úÖ Approbation envoy√©e! Attendez 10 secondes...');
                        await new Promise(r => setTimeout(r, 10000));
                    }
                }

                const safeSlippage = Math.max(slippage, 2);
                const amountOutMin = BigInt(Math.floor(Number(swapEstimateAmount) * (1 - safeSlippage/100)));

                if (!confirm(`Confirmer?\n\n${amount} ${TOKEN_NAMES[fromToken]} ‚Üí ~${(Number(swapEstimateAmount)/1e18).toFixed(6)} ${TOKEN_NAMES[toToken]}`)) {
                    return;
                }

                let path;
                if (isFromBNB || isToBNB) {
                    path = [fromToken, toToken];
                } else {
                    path = [fromToken, WBNB_ADDRESS, toToken];
                }

                const deadline = Math.floor(Date.now()/1000) + 1200;
                const userAddr = userAccount.substring(2).toLowerCase().padStart(64, '0');
                
                let swapData, swapValue = '0x0';
                
                if (isFromBNB) {
                    const pathEncoded = path.map(a => a.substring(2).toLowerCase().padStart(64, '0')).join('');
                    swapData = '0x7ff36ab5' +
                        amountOutMin.toString(16).padStart(64, '0') +
                        '00000000000000000000000000000000000000000000000000000000000000a0' +
                        userAddr +
                        deadline.toString(16).padStart(64, '0') +
                        path.length.toString(16).padStart(64, '0') +
                        pathEncoded;
                    swapValue = '0x' + amountWei.toString(16);
                } else if (isToBNB) {
                    const pathEncoded = path.map(a => a.substring(2).toLowerCase().padStart(64, '0')).join('');
                    swapData = '0x18cbafe5' +
                        amountWei.toString(16).padStart(64, '0') +
                        amountOutMin.toString(16).padStart(64, '0') +
                        '00000000000000000000000000000000000000000000000000000000000000a0' +
                        userAddr +
                        deadline.toString(16).padStart(64, '0') +
                        path.length.toString(16).padStart(64, '0') +
                        pathEncoded;
                } else {
                    const pathEncoded = path.map(a => a.substring(2).toLowerCase().padStart(64, '0')).join('');
                    swapData = '0x38ed1739' +
                        amountWei.toString(16).padStart(64, '0') +
                        amountOutMin.toString(16).padStart(64, '0') +
                        '00000000000000000000000000000000000000000000000000000000000000a0' +
                        userAddr +
                        deadline.toString(16).padStart(64, '0') +
                        path.length.toString(16).padStart(64, '0') +
                        pathEncoded;
                }

                const swapTx = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAccount,
                        to: PANCAKE_ROUTER,
                        data: swapData,
                        gas: '0x7A120',
                        value: swapValue
                    }]
                });

                await updateBalances();
                
                addToHistory({
                    type: 'success',
                    crypto: `${TOKEN_NAMES[fromToken]} ‚Üí ${TOKEN_NAMES[toToken]}`,
                    amount: amount,
                    txHash: swapTx,
                    date: new Date()
                });

                alert(`‚úÖ Swap r√©ussi!\nTX: ${swapTx}`);
                
                document.getElementById('swapEstimate').value = '';
                swapEstimateAmount = 0;

            } catch (error) {
                console.error('Erreur swap:', error);
                
                let errorMsg = error.message || 'Erreur inconnue';
                if (errorMsg.includes('user rejected')) errorMsg = 'Transaction annul√©e';
                if (errorMsg.includes('insufficient funds')) errorMsg = 'Fonds insuffisants';
                
                addToHistory({
                    type: 'failed',
                    crypto: `${TOKEN_NAMES[fromToken]} ‚Üí ${TOKEN_NAMES[toToken]}`,
                    amount: amount,
                    error: errorMsg,
                    date: new Date()
                });
                
                alert('‚ùå ' + errorMsg);
            }
        }

        // ============= HISTORIQUE =============

        function addToHistory(entry) {
            history.unshift(entry);
            
            const container = document.getElementById('historyContainer');
            const historyClass = entry.type === 'success' ? 'success' : 'failed';
            
            let detailsHtml = `
                <div class="history-time">${entry.date.toLocaleString('fr-FR')}</div>
                <div class="history-details">
                    <strong>${entry.type === 'success' ? '‚úÖ' : '‚ùå'} ${entry.crypto}</strong> - ${entry.amount.toFixed(4)}
            `;
            
            if (entry.type === 'success') {
                detailsHtml += `<br>TX: <a href="https://bscscan.com/tx/${entry.txHash}" target="_blank" style="color: #667eea;">${entry.txHash.substring(0, 10)}...</a>`;
            } else {
                detailsHtml += `<br>${entry.error}`;
            }
            
            detailsHtml += '</div>';
            
            const historyItem = document.createElement('div');
            historyItem.className = `history-item ${historyClass}`;
            historyItem.innerHTML = detailsHtml;
            
            if (history.length === 1) {
                container.innerHTML = '';
            }
            
            container.insertBefore(historyItem, container.firstChild);
            
            if (history.length > 20) {
                history.pop();
                container.removeChild(container.lastChild);
            }
        }

        async function updateNetwork() {
            await switchToBSC();
        }

        // ============= INIT =============

        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof window.ethereum === 'undefined') {
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('connectBtn').textContent = 'MetaMask non install√©';
                    document.getElementById('connectBtn').style.opacity = '0.5';
                }
            }, 1000);
        });
    </script>
</body>
</html>
